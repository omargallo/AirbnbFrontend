<div class="reviews-section mt-5">
  <!-- Reviews Header -->
  <div class="reviews-title">
    <!-- Dynamic overall rating -->
    <div class="overall-rating-display">
      <div class="overall-rating-stars">
        <app-star-component
          [maxStars]="1"
          [value]="getOverallRating()"
          [readonly]="true"
          [fontSize]="'1.5rem'"
          [starColor]="'black'"
        ></app-star-component>
        <h2 class="overall-rating-number mx-2">
          {{ getOverallRating() | number : "1.1-1" }}
        </h2>
      </div>
      <div class="reviews-count">
        <h2>
          <span class="reviews-count-number">{{ reviews.length }}</span>
          <span class="reviews-count-text mx-2">{{
            reviews.length === 1 ? "review" : "reviews"
          }}</span>
        </h2>
      </div>
    </div>
  </div>

  <!-- Add Review Call-to-Action -->
  <!-- <app-add-review-button
    *ngIf="propertyId"
    [propertyId]="propertyId"
    [propertyName]="propertyName"
  >
  </app-add-review-button> -->

  <!-- Reviews Modal - View Only -->

  <!-- @if(showReviewsModal){
  <app-reviews-modal
    [reviews]="reviews"
    [propertyId]="propertyId"
    (closeModal)="closeReviewsModal()"
  ></app-reviews-modal>
  }

   -->

  <app-reviews-modal
    *ngIf="showReviewsModal"
    [reviews]="reviews"
    [propertyId]="propertyId"
    (closeModal)="closeReviewsModal()"
  ></app-reviews-modal>

  <!-- Summary Row -->
  <div class="summary-row" *ngIf="reviews.length > 0">
    <!-- Overall Rating Breakdown -->
    <div class="rating-breakdown">
      <h6 class="mb-3">Overall rating</h6>
      <div class="rating-bars">
        <div class="rating-bar-item" *ngFor="let rating of [5, 4, 3, 2, 1]">
          <span class="rating-number">{{ rating }}</span>
          <div class="progress-bar-container">
            <div
              class="progress-bar"
              [style.width.%]="getRatingPercentage(rating)"
            ></div>
          </div>
          <span class="rating-count"
            >({{ ratingDistribution[rating] || 0 }})</span
          >
        </div>
      </div>
    </div>

    <!-- Category Ratings -->
    <div class="category-ratings">
      <div
        class="category-item"
        *ngFor="
          let category of [
            'cleanliness',
            'accuracy',
            'checkIn',
            'communication',
            'location',
            'value'
          ]
        "
      >
        <div class="category-icon-container">
          <i [class]="getCategoryIcon(category)" class="category-icon"></i>
        </div>
        <div class="category-info">
          <span class="category-label">{{
            category === "checkIn" ? "Check-in" : (category | titlecase)
          }}</span>
          <span class="category-rating">
            {{ categoryAverages[category] || "N/A" }}
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- No Reviews Message -->
  <div *ngIf="reviews.length === 0" class="no-reviews-message">
    <div class="text-center py-5">
      <i class="bi bi-star display-1 text-muted mb-3"></i>
      <h4 class="text-muted">No reviews yet</h4>
      <p class="text-muted">Be the first to share your experience!</p>
    </div>
  </div>

  <!-- Reviews Grid (Show only first 6) -->
  <div class="reviews-grid" *ngIf="reviews.length > 0">
    <div
      *ngFor="let review of reviews | slice : 0 : 6; trackBy: trackByReviewId"
      class="review-card"
    >
      <!-- Profile Section -->
      <div class="review-header">
        <div
          class="profile-section"
          role="button"
          tabindex="0"
          (click)="navigateToReviewerProfile(review.user.userId)"
          style="cursor: pointer"
        >
          <div class="profile-avatar">
            @if(review.user.profilePictureURL && !imageErrors.has(review.id)){
            <img
              [src]="getImageUrl(review.user.profilePictureURL)"
              class="rounded-circle"
              width="48"
              height="48"
              (error)="onImageError($event, review)"
            />
            } @if(!review.user.profilePictureURL || imageErrors.has(review.id)){
            <div
              class="bg-dark rounded-circle d-flex align-items-center justify-content-center text-white fw-bold"
              style="width: 48px; height: 48px"
            >
              {{ getInitials(review.user.firstName, review.user.lastName) }}
            </div>
            }
          </div>
          <div class="profile-info">
            <h6 class="reviewer-name text-decoration-underline-hover">
              {{ getFullName(review.user.firstName, review.user.lastName) }}
            </h6>
            <p class="reviewer-location text-muted" *ngIf="review.user.country">
              {{ review.user.country }}
            </p>
            <!-- <p class="reviewer-meta">Guest</p> -->
          </div>
        </div>

        <!-- Actions (Edit, View, Delete) - Only show for user's own reviews -->
        @if(currentUser && currentUser === review.user.userId){
        <div class="review-actions">
          <i
            (click)="navigateToEditReview(review)"
            class="action-icon text-dark bi bi-pencil-fill"
            title="Edit"
            style="cursor: pointer"
          ></i>
          <button
            type="button"
            class="btn p-0 action-icon text-dark"
            (click)="deleteHandler(review.id)"
            title="Delete"
          >
            <i class="bi bi-x-circle"></i>
          </button>
        </div>
        }
      </div>

      <!-- Rating and Date -->
      <div class="review-meta">
        <div class="review-stars">
          <app-star-component
            [fontSize]="'small'"
            [starColor]="'black'"
            [value]="review.rating"
            [readonly]="true"
          >
          </app-star-component>
        </div>
        <span class="review-date">{{ getDaysAgo(review.createdAt) }}</span>
        <span class="review-type">{{ getStayDuration(review) }}</span>
      </div>

      <!-- Review Content -->
      <div class="review-content">
        <p class="review-text">{{ review.comment }}</p>
        <button
          class="show-more-btn"
          type="button"
          (click)="openReviewsModal()"
          *ngIf="review.comment && review.comment.length > 150"
        >
          Show more
        </button>
      </div>
    </div>
  </div>

  <!-- Bottom Actions -->
  <div class="bottom-actions" *ngIf="reviews.length > 6">
    <button
      class="btn btn-outline-dark btn-lg show-all-btn"
      (click)="openReviewsModal()"
    >
      Show all {{ reviews.length }} reviews
    </button>
  </div>

  @if ( reviews.length > 0) {
  <div class="reviews-actions text-center">
    <button class="btn-view-reviews" (click)="openReviewsModal()">
      View All Reviews
    </button>
  </div>
  }

  <!-- Learn More Section -->
  <div
    class="learn-container d-flex justify-content-center"
    *ngIf="reviews.length > 0"
  >
    <a
      href="#"
      class="learn-link"
      (click)="toggleTooltip($event)"
      [attr.aria-expanded]="showTooltip"
    >
      Learn how reviews work
    </a>
    <!-- Tooltip -->
    <div class="tooltip-popup" [class.show]="showTooltip">
      <div class="tooltip-content">
        <p>
          Reviews from past guests help our community learn more about each
          home. By default, reviews are sorted by relevancy. Relevancy is based
          on recency, length, and information that you provide to us, such as
          your booking search, your country, and your language preferences.
        </p>
        <p>
          Only guests who booked a reservation can leave a review, and reviews
          are moderated for quality and authenticity. To be eligible for a
          percentile ranking or guest favorite label, listings need 5 or more
          recent reviews.
        </p>
      </div>
    </div>
  </div>
</div>

@if( shouldShowReviewButton()){
<div class="review-cta-container">
  <div class="character-illustration">
    <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
      <!-- 3D Character SVG (same as in the artifact above) -->
      <defs>
        <linearGradient id="skinGradient" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color: #ffd4b3" />
          <stop offset="100%" style="stop-color: #fdbf9a" />
        </linearGradient>
        <linearGradient id="shirtGradient" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color: #ff6b47" />
          <stop offset="100%" style="stop-color: #e74c2c" />
        </linearGradient>
        <linearGradient id="pantsGradient" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color: #5dade2" />
          <stop offset="100%" style="stop-color: #3498db" />
        </linearGradient>
      </defs>
      <!-- Body -->
      <ellipse cx="60" cy="75" rx="18" ry="25" fill="url(#shirtGradient)" />
      <!-- Arms -->
      <ellipse
        cx="42"
        cy="68"
        rx="8"
        ry="15"
        fill="url(#shirtGradient)"
        transform="rotate(-20 42 68)"
      />
      <ellipse
        cx="78"
        cy="68"
        rx="8"
        ry="15"
        fill="url(#shirtGradient)"
        transform="rotate(45 78 68)"
      />
      <!-- Hands -->
      <circle cx="38" cy="60" r="6" fill="url(#skinGradient)" />
      <circle cx="85" cy="75" r="6" fill="url(#skinGradient)" />
      <!-- Legs -->
      <ellipse cx="55" cy="95" rx="7" ry="18" fill="url(#pantsGradient)" />
      <ellipse cx="65" cy="95" rx="7" ry="18" fill="url(#pantsGradient)" />
      <!-- Shoes -->
      <ellipse cx="55" cy="110" rx="8" ry="5" fill="#34495E" />
      <ellipse cx="65" cy="110" rx="8" ry="5" fill="#34495E" />
      <!-- Head -->
      <circle cx="60" cy="40" r="20" fill="url(#skinGradient)" />
      <!-- Hair -->
      <path
        d="M 45 25 Q 60 15 75 25 Q 80 30 75 35 Q 70 20 60 20 Q 50 20 45 35 Q 40 30 45 25"
        fill="#8B4513"
      />
      <!-- Eyes -->
      <circle cx="54" cy="38" r="3" fill="white" />
      <circle cx="66" cy="38" r="3" fill="white" />
      <circle cx="54" cy="38" r="2" fill="black" />
      <circle cx="66" cy="38" r="2" fill="black" />
      <!-- Smile -->
      <path
        d="M 52 45 Q 60 50 68 45"
        stroke="#E74C2C"
        stroke-width="2"
        fill="none"
        stroke-linecap="round"
      />
      <!-- Waving motion lines -->
      <path
        d="M 30 55 Q 35 50 40 55"
        stroke="#FF385C"
        stroke-width="2"
        fill="none"
        opacity="0.6"
      />
      <path
        d="M 28 58 Q 33 53 38 58"
        stroke="#FF385C"
        stroke-width="1.5"
        fill="none"
        opacity="0.4"
      />
    </svg>
  </div>

  <div class="review-cta-text">
    <h3 class="review-cta-title">Share Your Experience</h3>
    <p class="review-cta-subtitle">Would you like to leave a review for us?</p>
  </div>

  <button class="review-btn" (click)="navigateToAddReview()">
    <span class="review-btn-text">
      <span class="heart-icon">ðŸ’•</span>
      Leave a Review
    </span>
  </button>
</div>
}

<div class="container" *ngIf="hostInfo && !isLoadingHost">
  <div class="row mt-5 pt-4" style="border-top: 1px solid #dee2e6">
    <div class="col-12">
      <h3 class="mb-4 fw-bold fs-3" style="letter-spacing: 1px">
        Meet your host
      </h3>

      <div class="row">
        <div class="col-xl-4 col-lg-5 col-md-6 col-12 mb-4 mb-lg-0">
          <app-profile-card
            [firstName]="hostInfo.firstName"
            [lastName]="hostInfo.lastName"
            [country]="hostInfo.country"
            [profileImageUrl]="hostInfo.profilePictureURL"
            [userId]="hostInfo.userId"
            [userType]="'Host'"
            [stats]="hostStats"
            [showHeartBadge]="isHostSuperhost()"
            [imageBaseUrl]="imageBaseUrl"
            [imageErrors]="imageError"
            [onImageErrorCallback]="onHostImageError"
          ></app-profile-card>
        </div>

        <div class="col-xl-1 d-none d-xl-block"></div>

        <div class="col-xl-7 col-lg-7 col-md-6 col-12">
          <div class="ms-lg-4 ms-md-3 ms-0">
            <h5 class="mb-3 fw-bold fs-4">Host details</h5>
            <div class="mb-3">
              <div class="text-muted mb-1 fs-5">
                Response rate: <span class="fw-semibold">100%</span>
              </div>
              <div class="text-muted fs-5">Responds within an hour</div>
            </div>

            <button
              class="btn mb-3 fw-semibold px-4 py-2"
              style="
                border-radius: 8px;
                font-size: 1rem;
                border: 1px solid #ebebeb;
                background-color: #ebebeb;
                color: #333;
                transition: all 0.2s ease;
              "
              onmouseover="this.style.backgroundColor='#d4d4d4'; this.style.borderColor='#d4d4d4'"
              onmouseout="this.style.backgroundColor='#ebebeb'; this.style.borderColor='#ebebeb'"
              onmousedown="this.style.transform='scale(0.95)'"
              onmouseup="this.style.transform='scale(1)'"
            >
              Message host
            </button>

            <div class="d-flex align-items-start text-muted">
              <i
                class="fas fa-shield-alt text-danger me-2 mt-1 flex-shrink-0"
              ></i>
              <span class="fs-6">
                To help protect your payment, always use Airbnb to send money
                and communicate with hosts.
              </span>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-4" *ngIf="hostInfo.description">
        <p class="text-muted fs-5">{{ hostInfo.description }}</p>
      </div>

      <!-- <div class="mt-2" *ngIf="hostInfo.userName">
        <small class="text-muted fs-6">{{ hostInfo.userName }}</small>
      </div> -->
    </div>
  </div>
</div>
